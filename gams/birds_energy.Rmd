---
title: "Birds - energy v abundance"
output: github_document
---

```{r}
library(dplyr)
library(gratia)
library(ggplot2)
load_mgcv()

ts <- read.csv(here::here("gams", "working_datasets.csv"))

unique_sites <- unique(ts$site_name)

site_dfs <- lapply(unique_sites, FUN = function(site, full_ts) return(filter(full_ts, site_name == site)), full_ts = ts)

source(here::here("gams", "gam_fxns", "wrapper_fxns.R"))
```

### Using Hartland

```{r select hartland}

birds <- filter(ts, site_name == "hartland")

abund_real <- ggplot(birds, aes(year, abundance)) +
  geom_line()

energy_real <- ggplot(birds, aes(year, energy)) +
  geom_line()

meane_real <- ggplot(birds, aes(year, mean_energy)) +
  geom_line() 

gridExtra::grid.arrange(grobs = list(abund_real, energy_real, meane_real), nrow = 1)

```

### Fit raw N and E and compare net

```{r raw separate}

e_mod <- mod_wrapper(birds, response_variable = "energy", identifier = "site_name", k = 5)
n_mod <- mod_wrapper(birds, response_variable = "abundance", identifier = "site_name", k = 5)

e_fit <- fit_wrapper(e_mod)
n_fit <- fit_wrapper(n_mod)

e_derivs <- deriv_wrapper(e_mod, ndraws = 100, seed_seed = 1977)
n_derivs <- deriv_wrapper(n_mod, ndraws = 100, seed_seed = 1977)

e_derivs_summary <- derivs_summary(e_derivs) %>%
  mutate(currency = "energy")
n_derivs_summary <- derivs_summary(n_derivs) %>%
  mutate(currency = "abundance")
# 
# e_v_n_summary <- bind_rows(e_derivs_summary, n_derivs_summary) %>%
#   group_by(currency) %>%
#   summarize_at(vars(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start), .funs = mean)

e_v_n_summary <- bind_rows(e_derivs_summary, n_derivs_summary) %>%
  tidyr::pivot_wider(id_cols = seed, names_from = currency, values_from = c(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start))

ggplot(e_v_n_summary, aes(mean(net_percent_of_start_abundance), mean(net_percent_of_start_energy))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1) +
  xlim(-.5, .5) +
  ylim(-.5, .5) +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0)

```

If you had many points, this could show you...

* If N or E increases/decreases/sits on 0 more
* If the trend for E matches the trend for N


In this case, E and N are behaving differently.... N has declined by about 15% relative to its starting value, but E has increased about 10-12%. 


```{r raw derivs plots}


ggplot(e_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))

ggplot(e_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


ggplot(n_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))
ggplot(n_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)

```


```{r raw separate many}

many_summaries <- list()

for(i in 1:length(unique_sites)) {

e_mod <- mod_wrapper(filter(ts, site_name == unique_sites[i]), response_variable = "energy", identifier = "site_name", k = 5)
n_mod <- mod_wrapper(filter(ts, site_name == unique_sites[i]), response_variable = "abundance", identifier = "site_name", k = 5)

e_derivs <- deriv_wrapper(e_mod, ndraws = 100, seed_seed = 1977)
n_derivs <- deriv_wrapper(n_mod, ndraws = 100, seed_seed = 1977)

e_derivs_summary <- derivs_summary(e_derivs) %>%
  mutate(currency = "energy")
n_derivs_summary <- derivs_summary(n_derivs) %>%
  mutate(currency = "abundance")
# 
# e_v_n_summary <- bind_rows(e_derivs_summary, n_derivs_summary) %>%
#   group_by(currency) %>%
#   summarize_at(vars(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start), .funs = mean)

many_summaries[[i]] <- bind_rows(e_derivs_summary, n_derivs_summary) %>%
  tidyr::pivot_wider(id_cols = c(seed, identifier), names_from = currency, values_from = c(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start))
}

many_summaries <- bind_rows(many_summaries) %>%
  group_by(identifier) %>%
  mutate(mean_net_abund = mean(net_percent_of_start_abundance),
         mean_net_energy = mean(net_percent_of_start_energy))


ggplot(many_summaries, aes(net_percent_of_start_abundance, net_percent_of_start_energy, group = identifier, color = identifier)) +
  geom_point() +
  geom_label(aes(mean_net_abund, mean_net_energy, label = identifier)) +
  geom_abline(intercept = 0, slope = 1)+
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0)
```
I guess, often they are in the same quadrant at least. Notably, you never see abundance increase and energy decline. 


### Mean e

```{r mean e}

meane_real

mean_e_mod <- gam(round(mean_energy) ~ s(year), data = birds, method = "REML")
mean_e_mod$identifier <- "hartland"
mean_e_mod_p <- gam(round(mean_energy) ~ s(year), data= birds, method = "REML", family = "poisson")
AIC(mean_e_mod)
AIC(mean_e_mod_p)

mean_e_fit <- fit_wrapper(mean_e_mod)

ggplot(mean_e_fit, aes(year, `round(mean_energy)`)) +
  geom_line() +
  geom_line(aes(year, fitted_value), color = "blue")

mean_e_derivs <- deriv_wrapper(mean_e_mod, seed_seed = 1977, ndraws =100)

ggplot(mean_e_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1) 

mean_e_derivs_summary <- derivs_summary(mean_e_derivs)

ggplot(mean_e_derivs_summary, aes(net_percent_of_start)) +
  geom_histogram()

```

```{r mean e scale}
mean_e_summaries <- list() 

for(i in 1:length(unique_sites)) {
mean_e_mod <- gam((mean_energy) ~ s(year), data = filter(ts, site_name == unique_sites[i]), method = "REML")
mean_e_mod$identifier <- unique_sites[i]

mean_e_derivs <- deriv_wrapper(mean_e_mod, seed_seed = 1977, ndraws =100)

mean_e_summaries[[i]] <- derivs_summary(mean_e_derivs)
}

mean_e_summaries <- bind_rows(mean_e_summaries)

ggplot(mean_e_summaries, aes(identifier, net_percent_of_start)) +
  geom_boxplot() +
  geom_hline(yintercept = 0)

ggplot(ts, aes(year, mean_energy)) +
  geom_line() +
  facet_wrap(vars(site_name), scales = "free")
```

Anecdotally.... the only sites where mean_e **appears** to change directionally are tilden and portal_rats. These are the only sites for which the mean_e net change entirely falls off of 0. These are also the sites for which the net change in energy vs net change in abundance are well off the 1:1 line.

### Scaled and compared directly

```{r scaled e and n}

scaled_birds <- birds %>%
  mutate(energy = scale(energy),
         abundance = scale(abundance))

scaled_n_mod <- gam(abundance ~ s(year), data = scaled_birds, method = "REML")

scaled_n_mod$identifier = "hartland"

scaled_e_mod <- gam(energy ~ s(year), data = scaled_birds, method = "REML")
scaled_e_mod$identifier = "hartland"



scaled_n_fit <- fit_wrapper(scaled_n_mod) %>%
  mutate(currency = "abundance") %>%
  rename(response = abundance)
scaled_e_fit <- fit_wrapper(scaled_e_mod) %>%
  mutate(currency = "energy") %>%
  rename(response = energy)

twofits <- bind_rows(scaled_n_fit, scaled_e_fit)

ggplot(twofits, aes(year, response, color = currency, group = currency)) +
  geom_point() +
  geom_line(aes(year, fitted_value))

scaled_e_derivs <- deriv_wrapper(scaled_e_mod, seed_seed = 1977, ndraws = 100)

scaled_n_derivs <- deriv_wrapper(scaled_n_mod, seed_seed = 1977, ndraws = 100)



e_scaled_summary <- derivs_summary(scaled_e_derivs) %>%
  mutate(currency  = "energy")

n_scaled_summary <- derivs_summary(scaled_n_derivs) %>%
  mutate(currency = "abundance")


scaled_summaries <- bind_rows(e_scaled_summary, n_scaled_summary) %>%
  tidyr::pivot_wider(id_cols = c(seed, identifier), names_from = currency, values_from = c(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start))

scaled_e_derivs <- scaled_e_derivs %>%
  select(year, upper, lower, mean) %>%
  distinct() %>%
  mutate(currency = "energy")

scaled_n_derivs <- scaled_n_derivs %>%
  select(year, upper, lower, mean) %>%
  distinct() %>%
  mutate(currency = "abundance")

scaled_derivs <- bind_rows(scaled_e_derivs, scaled_n_derivs) 


ggplot(scaled_derivs, aes(year, mean, color = currency, group = currency)) +
  geom_line() +
  geom_line(aes(year, upper)) +
  geom_line(aes(year, lower)) +
  geom_hline(yintercept = 0)

ggplot(scaled_summaries, aes(mean(net_percent_of_start_abundance), mean(net_percent_of_start_energy))) +
  geom_point() +
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0) +
  xlim(-10,10) +
  ylim(-10,10)



```
- Scaling and using the gaussian model changes the ways the models fit - no more wiggles. 
- Also changes the outcome for energy.
- Unclear what the magnitude means when you have a scaled response variable.
- Does however put the derivatives on the same scale so you can compare them a little more directly.

### Rescaling just E

```{r just e}

hartland_mean_perc_e <- sum(birds$energy) / sum(birds$abundance)

birds <- birds %>% 
  mutate(rescaled_energy = energy / hartland_mean_perc_e)


ggplot(birds, aes(year, energy)) +
  geom_line()
ggplot(birds, aes(year, rescaled_energy)) +
  geom_line() +
  geom_line(aes(year, abundance, color = "abund"))

birds_rs <- birds %>%
  mutate(energy = rescaled_energy)

re_e_mod <- mod_wrapper(birds_rs, response_variable = "energy", identifier = "site_name", k = 5)
n_mod <- mod_wrapper(birds_rs, response_variable = "abundance", identifier = "site_name", k = 5)

re_e_fit <- fit_wrapper(re_e_mod)
n_fit <- fit_wrapper(n_mod)

re_e_derivs <- deriv_wrapper(re_e_mod, ndraws = 100, seed_seed = 1977)
n_derivs <- deriv_wrapper(n_mod, ndraws = 100, seed_seed = 1977)

re_e_derivs_summary <- derivs_summary(re_e_derivs) %>%
  mutate(currency = "energy")
n_derivs_summary <- derivs_summary(n_derivs) %>%
  mutate(currency = "abundance")
# 
# e_v_n_summary <- bind_rows(e_derivs_summary, n_derivs_summary) %>%
#   group_by(currency) %>%
#   summarize_at(vars(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start), .funs = mean)

re_e_v_n_summary <- bind_rows(re_e_derivs_summary, n_derivs_summary) %>%
  tidyr::pivot_wider(id_cols = seed, names_from = currency, values_from = c(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start))

ggplot(re_e_v_n_summary, aes(mean(net_percent_of_start_abundance), mean(net_percent_of_start_energy))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)+
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0)




ggplot(re_e_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))

ggplot(re_e_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


ggplot(n_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))
ggplot(n_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


both_derivs <- bind_rows(energy = re_e_derivs, abund= n_derivs, .id = "currency")

ggplot(filter(both_derivs, currency == "energy"), aes(year, derivative, group = seed)) +
  geom_line(alpha = .1) +
  geom_line(data = filter(both_derivs, currency == "abund"), inherit.aes = T, alpha = .1, color = "green")
  
both_derivs %>%
  group_by(currency, seed) %>%
  summarize(sd = sd(derivative),
            cv = sd(derivative) / mean(derivative)) %>%
  ungroup() %>%
  group_by(currency) %>%
  summarize(mean_cv = mean(cv),
            mean_sd = mean(sd))
```

#### With portal

```{r just e portal}

rats <- filter(ts, site_name == "portal_rats")

portal_mean_perc_e <- sum(rats$energy) / sum(rats$abundance)

rats <- rats %>% 
  mutate(rescaled_energy = energy / portal_mean_perc_e)


ggplot(rats, aes(year, energy)) +
  geom_line()
ggplot(rats, aes(year, rescaled_energy)) +
  geom_line() +
  geom_line(aes(year, abundance, color = "abund"))

rats_rs <- rats %>%
  mutate(energy = rescaled_energy)

re_e_mod <- mod_wrapper(rats_rs, response_variable = "energy", identifier = "site_name", k = 5)
n_mod <- mod_wrapper(rats_rs, response_variable = "abundance", identifier = "site_name", k = 5)

re_e_fit <- fit_wrapper(re_e_mod)
n_fit <- fit_wrapper(n_mod)

re_e_derivs <- deriv_wrapper(re_e_mod, ndraws = 100, seed_seed = 1977)
n_derivs <- deriv_wrapper(n_mod, ndraws = 100, seed_seed = 1977)

re_e_derivs_summary <- derivs_summary(re_e_derivs) %>%
  mutate(currency = "energy")
n_derivs_summary <- derivs_summary(n_derivs) %>%
  mutate(currency = "abundance")
# 
# e_v_n_summary <- bind_rows(e_derivs_summary, n_derivs_summary) %>%
#   group_by(currency) %>%
#   summarize_at(vars(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start), .funs = mean)

re_e_v_n_summary <- bind_rows(re_e_derivs_summary, n_derivs_summary) %>%
  tidyr::pivot_wider(id_cols = seed, names_from = currency, values_from = c(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start))

ggplot(re_e_v_n_summary, aes(mean(net_percent_of_start_abundance), mean(net_percent_of_start_energy))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)+
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0)




ggplot(re_e_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))

ggplot(re_e_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


ggplot(n_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))
ggplot(n_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


both_derivs <- bind_rows(energy = re_e_derivs, abund= n_derivs, .id = "currency")

ggplot(filter(both_derivs, currency == "energy"), aes(year, derivative, group = seed)) +
  geom_line(alpha = .1) +
  geom_line(data = filter(both_derivs, currency == "abund"), inherit.aes = T, alpha = .1, color = "green")
  

both_derivs %>%
  group_by(currency, seed) %>%
  summarize(sd = sd(derivative),
            cv = sd(derivative) / mean(derivative)) %>%
  ungroup() %>%
  group_by(currency) %>%
  summarize(mean_cv = mean(cv),
            mean_sd = mean(sd))
```


#### With alberta (tracks)

```{r just e alberta}

alberta <- filter(ts, site_name == "alberta")

alberta_mean_perc_e <- sum(alberta$energy) / sum(alberta$abundance)

alberta <- alberta %>% 
  mutate(rescaled_energy = energy / alberta_mean_perc_e)


ggplot(alberta, aes(year, energy)) +
  geom_line()
ggplot(alberta, aes(year, rescaled_energy)) +
  geom_line() +
  geom_line(aes(year, abundance, color = "abund"))

alberta_rs <- alberta %>%
  mutate(energy = rescaled_energy)

re_e_mod <- mod_wrapper(alberta_rs, response_variable = "energy", identifier = "site_name", k = 5)
n_mod <- mod_wrapper(alberta_rs, response_variable = "abundance", identifier = "site_name", k = 5)

re_e_fit <- fit_wrapper(re_e_mod)
n_fit <- fit_wrapper(n_mod)

re_e_derivs <- deriv_wrapper(re_e_mod, ndraws = 100, seed_seed = 1977)
n_derivs <- deriv_wrapper(n_mod, ndraws = 100, seed_seed = 1977)

re_e_derivs_summary <- derivs_summary(re_e_derivs) %>%
  mutate(currency = "energy")
n_derivs_summary <- derivs_summary(n_derivs) %>%
  mutate(currency = "abundance")
# 
# e_v_n_summary <- bind_rows(e_derivs_summary, n_derivs_summary) %>%
#   group_by(currency) %>%
#   summarize_at(vars(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start), .funs = mean)

re_e_v_n_summary <- bind_rows(re_e_derivs_summary, n_derivs_summary) %>%
  tidyr::pivot_wider(id_cols = seed, names_from = currency, values_from = c(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start))

ggplot(re_e_v_n_summary, aes((net_percent_of_start_abundance), (net_percent_of_start_energy))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)+
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0)




ggplot(re_e_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))

ggplot(re_e_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


ggplot(n_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))
ggplot(n_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


both_derivs <- bind_rows(energy = re_e_derivs, abund= n_derivs, .id = "currency")

ggplot(filter(both_derivs, currency == "energy"), aes(year, derivative, group = seed)) +
  geom_line(alpha = .1) +
  geom_line(data = filter(both_derivs, currency == "abund"), inherit.aes = T, alpha = .1, color = "green")
  
both_derivs %>%
  group_by(currency, seed) %>%
  summarize(sd = sd(derivative),
            cv = sd(derivative) / mean(derivative)) %>%
  ungroup() %>%
  group_by(currency) %>%
  summarize(mean_cv = mean(cv),
            mean_sd = mean(sd))
```

#### With tilden 

```{r just e tilden}

tilden <- filter(ts, site_name == "tilden")

tilden_mean_perc_e <- sum(tilden$energy) / sum(tilden$abundance)

tilden <- tilden %>% 
  mutate(rescaled_energy = energy / tilden_mean_perc_e)


ggplot(tilden, aes(year, energy)) +
  geom_line()
ggplot(tilden, aes(year, rescaled_energy)) +
  geom_line() +
  geom_line(aes(year, abundance, color = "abund"))

tilden_rs <- tilden %>%
  mutate(energy = rescaled_energy)

re_e_mod <- mod_wrapper(tilden_rs, response_variable = "energy", identifier = "site_name", k = 5)
n_mod <- mod_wrapper(tilden_rs, response_variable = "abundance", identifier = "site_name", k = 5)

re_e_fit <- fit_wrapper(re_e_mod)
n_fit <- fit_wrapper(n_mod)

re_e_derivs <- deriv_wrapper(re_e_mod, ndraws = 100, seed_seed = 1977)
n_derivs <- deriv_wrapper(n_mod, ndraws = 100, seed_seed = 1977)

re_e_derivs_summary <- derivs_summary(re_e_derivs) %>%
  mutate(currency = "energy")
n_derivs_summary <- derivs_summary(n_derivs) %>%
  mutate(currency = "abundance")
# 
# e_v_n_summary <- bind_rows(e_derivs_summary, n_derivs_summary) %>%
#   group_by(currency) %>%
#   summarize_at(vars(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start), .funs = mean)

re_e_v_n_summary <- bind_rows(re_e_derivs_summary, n_derivs_summary) %>%
  tidyr::pivot_wider(id_cols = seed, names_from = currency, values_from = c(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start))

ggplot(re_e_v_n_summary, aes((net_percent_of_start_abundance), (net_percent_of_start_energy))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)+
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0)




ggplot(re_e_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))

ggplot(re_e_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


ggplot(n_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))
ggplot(n_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


both_derivs <- bind_rows(energy = re_e_derivs, abund= n_derivs, .id = "currency")

ggplot(filter(both_derivs, currency == "energy"), aes(year, derivative, group = seed)) +
  geom_line(alpha = .1) +
  geom_line(data = filter(both_derivs, currency == "abund"), inherit.aes = T, alpha = .1, color = "green")


both_derivs %>%
  group_by(currency, seed) %>%
  summarize(sd = sd(derivative),
            cv = sd(derivative) / mean(derivative)) %>%
  ungroup() %>%
  group_by(currency) %>%
  summarize(mean_cv = mean(cv),
            mean_sd = mean(sd))
```


#### With mccoy

```{r just e mccoy}

mccoy <- filter(ts, site_name == "mccoy")

mccoy_mean_perc_e <- sum(mccoy$energy) / sum(mccoy$abundance)

mccoy <- mccoy %>% 
  mutate(rescaled_energy = energy / mccoy_mean_perc_e)


ggplot(mccoy, aes(year, energy)) +
  geom_line()
ggplot(mccoy, aes(year, rescaled_energy)) +
  geom_line() +
  geom_line(aes(year, abundance, color = "abund"))

mccoy_rs <- mccoy %>%
  mutate(energy = rescaled_energy)

re_e_mod <- mod_wrapper(mccoy_rs, response_variable = "energy", identifier = "site_name", k = 5)
n_mod <- mod_wrapper(mccoy_rs, response_variable = "abundance", identifier = "site_name", k = 5)

re_e_fit <- fit_wrapper(re_e_mod)
n_fit <- fit_wrapper(n_mod)

re_e_derivs <- deriv_wrapper(re_e_mod, ndraws = 100, seed_seed = 1977)
n_derivs <- deriv_wrapper(n_mod, ndraws = 100, seed_seed = 1977)

re_e_derivs_summary <- derivs_summary(re_e_derivs) %>%
  mutate(currency = "energy")
n_derivs_summary <- derivs_summary(n_derivs) %>%
  mutate(currency = "abundance")
# 
# e_v_n_summary <- bind_rows(e_derivs_summary, n_derivs_summary) %>%
#   group_by(currency) %>%
#   summarize_at(vars(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start), .funs = mean)

re_e_v_n_summary <- bind_rows(re_e_derivs_summary, n_derivs_summary) %>%
  tidyr::pivot_wider(id_cols = seed, names_from = currency, values_from = c(net_change, abs_change, abs_v_net_change, net_percent_of_start, abs_percent_of_start))

ggplot(re_e_v_n_summary, aes((net_percent_of_start_abundance), (net_percent_of_start_energy))) +
  geom_point() +
  geom_abline(intercept = 0, slope = 1)+
  geom_vline(xintercept = 0) +
  geom_hline(yintercept = 0)




ggplot(re_e_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))

ggplot(re_e_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


ggplot(n_fit, aes(year, dependent)) +
  geom_point() +
  geom_line(aes(year, fitted_value))
ggplot(n_derivs, aes(year, derivative, group = seed)) +
  geom_line(alpha = .1)


both_derivs <- bind_rows(energy = re_e_derivs, abund= n_derivs, .id = "currency")

ggplot(filter(both_derivs, currency == "energy"), aes(year, derivative, group = seed)) +
  geom_line(alpha = .1) +
  geom_line(data = filter(both_derivs, currency == "abund"), inherit.aes = T, alpha = .1, color = "green")

both_derivs %>%
  group_by(currency, seed) %>%
  summarize(sd = sd(derivative),
            cv = sd(derivative) / mean(derivative)) %>%
  ungroup() %>%
  group_by(currency) %>%
  summarize(mean_cv = mean(cv),
            mean_sd = mean(sd))
  
```

* you don't want cv or sd of derivatives. you maybe want the cv of the fitted/predicted estimates.
* contrive nulls: one where e exactly tracks n (amplifying the same size structure); one where the ss trades off such that e does not change while n does
