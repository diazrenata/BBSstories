---
title: "Interpreting breakpoint fits"
output: 
    github_document:
       df_print: kable
       fig_width: 3
       fig_height: 3
params:
 this_dataset: ["all"]
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(dplyr)
library(ggplot2)
library(strucchange)
```

## An idea

Look specifically at the predictions from the best-fitting breakpoint model. (This model could be: no breakpoints + no slope, no breakpoints + slope, n breakpoints + no slope, n breakpoints + slopes).

There's some qualitative behaviors we can extract from the predictions (that come logically but less elegantly from the parameters, etc).

Two axes:

1. **Monotonic or squiggly:** Monotonic can encompass all linear (no-break) models, _and_ any models with breakpoints that do not result in changes in direction. 
2. **Net change or net 0:** The ratio of the end:beginning _prediction_.

The 2x2:

1. **Monotonic** and **net change**: This would be some kind of overall trend, either steady (probably would show as a 1-segment linear model), possibly accelerating or decelerating across the timeseries (would show as multiple segments with slopes), or even as a series of abrupt changes (would show as multiple segments with *no* slopes).
2. **Monotonic** and **no net change**: This can basically only be accomplished as a one-segment linear model with a slope very close to 0. (Theoretically you could have many verrrrry gently sloping segments, but I doubt we have the statistical power such that something like that would emerge as the best fit). I think this is either very stable or *so* variable that not even many breakpoints can adequately capture the variability. 
3. **Turnpoints** and **net change**: The TS changes direction at least once, and ends up somewhere other than where it started. This *must* involve breakpoints. At the moment I think I have less confidence in such an outcome as evidence of systematic directional change - it seems potentially sensitive to, if we stopped surveying 5 years earlier, would we have a totally different trend? 
4. **Turnpoints** and **no net change**: Qualitatively different from, monotonic and no net change....Again, I am not sure how confident I am in this as a signal of any kind of regulation/buffering. But maybe. 


### Illustration via a few real datasets

```{r loading some real datasets, fig.dim = c(6, 24), warning=FALSE, echo = FALSE, include = FALSE, messages =FALSE}

site_names <- list.files(path = "C:\\Users\\diaz.renata\\Documents\\GitHub\\BBSsize\\analysis\\isd_data", pattern = "ibd_isd_bbs_", full.names = F)
site_names <- substr(site_names, 18, nchar(site_names))
site_names <- substr(site_names, 1, nchar(site_names) - 4)
site_names <- site_names[1:500]

datasets <- data.frame(
  dataset_name = site_names,
  rtrg_code = paste0("rtrg_", site_names)
)


all_datasets <- list()


for(i in 1:nrow(datasets)) {

  if(datasets$dataset_name[i] != "portal_rats") {

    ibd <- readRDS(paste0("C:\\Users\\diaz.renata\\Documents\\GitHub\\BBSsize\\analysis\\isd_data\\ibd_isd_bbs_", datasets$rtrg_code[i], ".Rds"))

    sv <- ibd %>%
      group_by(year) %>%
      summarize(richness = length(unique(id)),
                abundance = dplyr::n(),
                biomass = sum(ind_size),
                energy = sum(ind_b)) %>%
      ungroup() %>%
      mutate(mean_energy = energy / abundance,
             mean_mass = biomass/abundance,
             site_name = datasets$dataset_name[i])

    if(datasets$dataset_name[i] == "gainesville_nooutlier") {
      sv <- filter(sv, abundance < 3000)
    }
  } else {

    individual_rats <- portalr::summarise_individual_rodents(clean = TRUE, type = "Granivores", time = "date", length = "Longterm")

    ibd <- individual_rats %>%
      filter(year %in% c(1978:2002), !is.na(wgt), treatment == "control") %>%
      mutate(six_mo = ifelse(month > 6, .5, 0)) %>%
      mutate(year_six_mo = (year + six_mo)) %>%
      mutate(bmr = 5.69 * (wgt ^ .75)) %>%
      select(year_six_mo, species, wgt, bmr) %>%
      rename(year= year_six_mo,
             id = species,
             ind_size = wgt,
             ind_b = bmr) %>%
      mutate(id = as.character(id))


    sv <- ibd %>%
      group_by(year) %>%
      summarize(richness = length(unique(id)),
                abundance = dplyr::n(),
                biomass = sum(ind_size),
                energy = sum(ind_b)) %>%
      ungroup() %>%
      mutate(mean_energy = energy / abundance,
             mean_mass = biomass/abundance,
             site_name = datasets$dataset_name[i]) %>%
      mutate(time = row_number())

  }

  all_datasets[[i]] <- sv


}

all_datasets <- bind_rows(all_datasets)


```

```{r breakpoints fxns}
source(here::here("stories", "datasets", "fxns.R"))

```

```{r multiple datasets}

abund_mods <- list()

for(i in 1:nrow(datasets)) {
  thisdat <- subset_all_datasets(site = datasets$dataset_name[i], curr = "abundance", all_datasets = all_datasets)

  abund_mods[[i]] <- summarize_breakpoints(thisdat, fit_breakpoints(thisdat))
}

abund_mods <- dplyr::bind_rows(abund_mods)
# 
# ggplot(abund_mods, aes(time, response, color = monotonic)) +
#   geom_line() +
#   geom_point(aes(time, fitted)) +
#   facet_wrap(vars(site_name), scales = "free")



energy_mods <- list()

for(i in 1:nrow(datasets)) {
  thisdat <- subset_all_datasets(site = datasets$dataset_name[i], curr = "energy", all_datasets = all_datasets)

  energy_mods[[i]] <- summarize_breakpoints(thisdat, fit_breakpoints(thisdat))
}

energy_mods <- dplyr::bind_rows(energy_mods)
# 
# ggplot(energy_mods, aes(time, response, color = monotonic)) +
#   geom_line() +
#   geom_point(aes(time, fitted)) +
#   facet_wrap(vars(site_name), scales = "free")

all_mods <- bind_rows(energy_mods, abund_mods) %>%
  mutate(site_curr = paste0(as.character(site_name), currency)) %>%
  mutate(cap_change = cap_p_wilcox <= 0.05,
         lm_change = lm_ratio != 1,
         monotonic_word = ifelse(monotonic, "monotonic", "turns"),
         monotonic_lm_steps = ifelse(monotonic, ifelse(lm_change, "monotonic", ifelse(nbp > 0, "monotonic", "monotonic flat")), "turns"),
         monotonic_cap_steps =ifelse(monotonic, ifelse(cap_change, "monotonic", ifelse(nbp > 0, "monotonic", "monotonic flat")), "turns")) %>%
  mutate(cap_increase = ifelse(cap_change, cap_ratio > 1, FALSE),
         cap_decrease = ifelse(cap_change, cap_ratio < 1, FALSE),
         lm_increase = ifelse(lm_change, lm_ratio > 1, FALSE),
         lm_decrease =ifelse(lm_change, lm_ratio < 1, FALSE),
         lm_change_word = ifelse(lm_change, paste0(monotonic_word, " trend"), paste0(monotonic_word, " no trend")),
         lm_change_description = ifelse(lm_change, 
                                        ifelse(lm_increase, "increase",
                                               "decrease"),
                                        "no trend"),
         cap_change_word = ifelse(cap_change, paste0(monotonic_word, " change"), paste0(monotonic_word, " no change")),
         cap_change_description = ifelse(cap_change,
                                         ifelse(cap_increase, "increase", 
                                                "decrease"),
                                         "no change"))
```
### Grouped by turns/no

```{r group by turns}


mod_summary <- all_mods %>%
  filter(currency == "abundance") %>%
  select(-time, -response, -fitted, -breakpoints) %>%
  distinct() %>%
  mutate(cap_lm_agree = cap_change == lm_change)

ggplot(filter(mod_summary, currency == "abundance"), aes(x = monotonic)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  ggtitle("Abundance")

ggplot(filter(mod_summary, currency == "abundance"), aes(x = lm_change_word, group = lm_change_description, fill = lm_change_description)) +
  geom_bar(position = "stack") + 
  theme_bw() +
  ggtitle("Abundance") +
  scale_fill_viridis_d() +
  theme(legend.position = "top")


abundance_summary <- mod_summary %>%
  filter(currency == "abundance") %>%
  group_by(monotonic) %>%
  mutate(n_mono_or_turns = dplyr::n()) %>%
  ungroup() %>%
  group_by(monotonic, lm_change_word) %>%
  mutate(n_trend_or_no = dplyr::n()) %>%
  ungroup() %>%
  group_by(monotonic, lm_change_description) %>%
  mutate(n_lm_change_description = dplyr::n()) %>%
  ungroup() %>%
  select(currency, monotonic, n_mono_or_turns,lm_change_description, n_lm_change_description, lm_change_word, n_trend_or_no) %>%
  distinct() %>%
  arrange(monotonic, lm_change_description)
  
print(abundance_summary)

```

### Grouped by trend


```{r group by trend}
ggplot(filter(mod_summary, currency == "abundance"), aes(x = lm_change_description)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  ggtitle("Abundance by lm() slope")

ggplot(filter(mod_summary, currency == "abundance"), aes(x = lm_change_description, group = monotonic_word, fill = monotonic_word)) +
  geom_bar(position = "stack") + 
  theme_bw() +
  ggtitle("Abundance by lm() slope") +
  scale_fill_viridis_d()+
  theme(legend.position = "top")


abundance_summary2 <- mod_summary %>%
  filter(currency == "abundance") %>%
  group_by(lm_change_description) %>%
  mutate(n_trend_type = dplyr::n()) %>%
  ungroup() %>%
  group_by(monotonic, lm_change_description) %>%
  mutate(n_monotonic_trend = dplyr::n()) %>%
  ungroup() %>%
  select(currency, lm_change_description, n_trend_type,monotonic, n_monotonic_trend) %>%
  distinct() %>%
  arrange(lm_change_description, monotonic)
  
print(abundance_summary2)


ggplot(filter(mod_summary, currency == "abundance"), aes(x = cap_change_description)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  ggtitle("Abundance by beginning-end comparison")


ggplot(filter(mod_summary, currency == "abundance"), aes(x = cap_change_description, group = monotonic_word, fill = monotonic_word)) +
  geom_bar(position = "stack") + 
  theme_bw() +
  ggtitle("Abundance by beginning-end comparison") +
  scale_fill_viridis_d()+
  theme(legend.position = "top")

ggplot(filter(mod_summary, currency == "abundance"), aes(x = cap_change_description, group = monotonic_cap_steps, fill = monotonic_cap_steps)) +
  geom_bar(position = "stack") + 
  theme_bw() +
  ggtitle("Abundance by beginning-end comparison") +
  scale_fill_viridis_d()+
  theme(legend.position = "top")



abundance_summary3 <- mod_summary %>%
  filter(currency == "abundance") %>%
  group_by(cap_change_description) %>%
  mutate(n_trend_type = dplyr::n()) %>%
  ungroup() %>%
  group_by(monotonic, cap_change_description) %>%
  mutate(n_monotonic_trend = dplyr::n()) %>%
  ungroup() %>%
  select(currency, cap_change_description, n_trend_type,monotonic, n_monotonic_trend) %>%
  distinct() %>%
  arrange(cap_change_description, monotonic)
  
print(abundance_summary3)
```

## Distributions of slopes

```{r slopes}

ggplot(filter(mod_summary, lm_change), aes(lm_p_ratio)) +
  geom_histogram() +
#  facet_wrap(vars(lm_change_word)) +
  theme_bw() +
  geom_vline(xintercept = 1)



ggplot(filter(mod_summary, lm_change, lm_change_word == "monotonic trend"), aes(lm_p_ratio)) +  geom_histogram() +
  facet_wrap(vars(lm_change_word)) +
  theme_bw() +
  geom_vline(xintercept = 1)
# 
# ggplot(mod_summary, aes(x = lm_change, y = cv, color = monotonic_word)) +
#   geom_boxplot() +
#   theme_bw() +
#   theme(legend.position = "top")
# 
# 
# ggplot(mod_summary, aes(x = lm_change, y = cv, color = monotonic_lm_steps)) +
#   geom_boxplot() +
#   theme_bw() +
#   theme(legend.position = "top")

ggplot(filter(mod_summary, lm_change_word == "monotonic no trend"), aes(x = cv)) +
  geom_histogram() +
  theme_bw() +
  ggtitle("Abundance")

```

# The actual time series

## Monotonics

### No significant trend

#### Steps

```{r plot abund monot flat steps, fig.dim = c(2,2), eval = F}
abund_monotonics <- filter(mod_summary, currency == "abundance", monotonic, !lm_change, nbp > 0)
for(i in 1:nrow(abund_monotonics)) {
  thisdat <- filter(all_mods, site_curr == abund_monotonics$site_curr[i])

  thiscolor <- ifelse(abund_monotonics$lm_change[i], "red", "blue")


  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}

cvs <- abund_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)

```


#### "Static"

```{r plot abund monot flat no steps, fig.dim = c(2,2), eval = F}
abund_monotonics <- filter(mod_summary, currency == "abundance", monotonic, !lm_change, nbp == 0)
for(i in 1:nrow(abund_monotonics)) {
  thisdat <- filter(all_mods, site_curr == abund_monotonics$site_curr[i])

  thiscolor <- ifelse(abund_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(abund_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}


cvs <- abund_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)

```


### Inscreasing

```{r plot abund monot inc, fig.dim = c(2,2), eval = F}
abund_monotonics <- filter(mod_summary, currency == "abundance", monotonic, lm_change, lm_increase)
for(i in 1:nrow(abund_monotonics)) {
  thisdat <- filter(all_mods, site_curr == abund_monotonics$site_curr[i])

  thiscolor <- ifelse(abund_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(abund_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}


cvs <- abund_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)
```

### Decreasing

```{r plot abund monot dec, fig.dim = c(2,2), eval = F}
abund_monotonics <- filter(mod_summary, currency == "abundance", monotonic, lm_change, lm_decrease)
for(i in 1:nrow(abund_monotonics)) {
  thisdat <- filter(all_mods, site_curr == abund_monotonics$site_curr[i])

  thiscolor <- ifelse(abund_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(abund_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
     geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}


cvs <- abund_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)
```

## Turns

### No significant trend

#### Steps

```{r plot abund turns no trend, fig.dim = c(2,2), eval = F}
abund_monotonics <- filter(mod_summary, currency == "abundance", !monotonic, !lm_change, nbp > 0)
for(i in 1:nrow(abund_monotonics)) {
  thisdat <- filter(all_mods, site_curr == abund_monotonics$site_curr[i])

  thiscolor <- ifelse(abund_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(abund_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}



cvs <- abund_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)

```


### Increasing

```{r plot abund turns inc, fig.dim = c(2,2), eval = F}
abund_monotonics <- filter(mod_summary, currency == "abundance", !monotonic, lm_change, lm_increase)
for(i in 1:nrow(abund_monotonics)) {
  thisdat <- filter(all_mods, site_curr == abund_monotonics$site_curr[i])

  thiscolor <- ifelse(abund_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(abund_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
     geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}


cvs <- abund_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)
```

### Decreasing

```{r plot abund turns dec, fig.dim = c(2,2), eval = F}
abund_monotonics <- filter(mod_summary, currency == "abundance", !monotonic, lm_change, lm_decrease)
for(i in 1:nrow(abund_monotonics)) {
  thisdat <- filter(all_mods, site_curr == abund_monotonics$site_curr[i])

  thiscolor <- ifelse(abund_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(abund_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}


cvs <- abund_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)
```

# Energy
### Grouped by turns/no

```{r energy group by turns}


mod_summary <- all_mods %>%
  filter(currency == "energy") %>%
  select(-time, -response, -fitted, -breakpoints) %>%
  distinct() %>%
  mutate(cap_lm_agree = cap_change == lm_change)

ggplot(filter(mod_summary, currency == "energy"), aes(x = monotonic)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  ggtitle("Energy")

ggplot(filter(mod_summary, currency == "energy"), aes(x = lm_change_word, group = lm_change_description, fill = lm_change_description)) +
  geom_bar(position = "stack") + 
  theme_bw() +
  ggtitle("Energy") +
  scale_fill_viridis_d() +
  theme(legend.position = "top")


energy_summary <- mod_summary %>%
  filter(currency == "energy") %>%
  group_by(monotonic) %>%
  mutate(n_mono_or_turns = dplyr::n()) %>%
  ungroup() %>%
  group_by(monotonic, lm_change_word) %>%
  mutate(n_trend_or_no = dplyr::n()) %>%
  ungroup() %>%
  group_by(monotonic, lm_change_description) %>%
  mutate(n_lm_change_description = dplyr::n()) %>%
  ungroup() %>%
  select(currency, monotonic, n_mono_or_turns,lm_change_description, n_lm_change_description, lm_change_word, n_trend_or_no) %>%
  distinct() %>%
  arrange(monotonic, lm_change_description)
  
print(energy_summary)

```

### Grouped by trend


```{r energy group by trend}
ggplot(filter(mod_summary, currency == "energy"), aes(x = lm_change_description)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  ggtitle("Energy by lm() slope")

ggplot(filter(mod_summary, currency == "energy"), aes(x = lm_change_description, group = monotonic_word, fill = monotonic_word)) +
  geom_bar(position = "stack") + 
  theme_bw() +
  ggtitle("Energy by lm() slope") +
  scale_fill_viridis_d()+
  theme(legend.position = "top")


energy_summary2 <- mod_summary %>%
  filter(currency == "energy") %>%
  group_by(lm_change_description) %>%
  mutate(n_trend_type = dplyr::n()) %>%
  ungroup() %>%
  group_by(monotonic, lm_change_description) %>%
  mutate(n_monotonic_trend = dplyr::n()) %>%
  ungroup() %>%
  select(currency, lm_change_description, n_trend_type,monotonic, n_monotonic_trend) %>%
  distinct() %>%
  arrange(lm_change_description, monotonic)
  
print(energy_summary2)


ggplot(filter(mod_summary, currency == "energy"), aes(x = cap_change_description)) +
  geom_bar(position = "dodge") +
  theme_bw() +
  ggtitle("Energy by beginning-end comparison")


ggplot(filter(mod_summary, currency == "energy"), aes(x = cap_change_description, group = monotonic_word, fill = monotonic_word)) +
  geom_bar(position = "stack") + 
  theme_bw() +
  ggtitle("Energy by beginning-end comparison") +
  scale_fill_viridis_d()+
  theme(legend.position = "top")

ggplot(filter(mod_summary, currency == "energy"), aes(x = cap_change_description, group = monotonic_cap_steps, fill = monotonic_cap_steps)) +
  geom_bar(position = "stack") + 
  theme_bw() +
  ggtitle("Energy by beginning-end comparison") +
  scale_fill_viridis_d()+
  theme(legend.position = "top")



energy_summary3 <- mod_summary %>%
  filter(currency == "energy") %>%
  group_by(cap_change_description) %>%
  mutate(n_trend_type = dplyr::n()) %>%
  ungroup() %>%
  group_by(monotonic, cap_change_description) %>%
  mutate(n_monotonic_trend = dplyr::n()) %>%
  ungroup() %>%
  select(currency, cap_change_description, n_trend_type,monotonic, n_monotonic_trend) %>%
  distinct() %>%
  arrange(cap_change_description, monotonic)
  
print(energy_summary3)
```

## Distributions of slopes

```{r energy slopes}

ggplot(filter(mod_summary, lm_change), aes(lm_p_ratio)) +
  geom_histogram() +
#  facet_wrap(vars(lm_change_word)) +
  theme_bw() +
  geom_vline(xintercept = 1)



ggplot(filter(mod_summary, lm_change, lm_change_word == "monotonic trend"), aes(lm_p_ratio)) +
  geom_histogram() +
  facet_wrap(vars(lm_change_word)) +
  theme_bw() +
  geom_vline(xintercept = 1)

ggplot(mod_summary, aes(x = lm_change, y = cv, color = monotonic_word)) +
  geom_boxplot() +
  theme_bw() +
  theme(legend.position = "top")


ggplot(filter(mod_summary, lm_change_word == "monotonic no trend"), aes(x = cv)) +
  geom_histogram() +
  theme_bw() +
  ggtitle("Energy")
```

# The actual time series

## Monotonics

### No significant trend

#### Steps

```{r plot energy monot flat steps, fig.dim = c(2,2), eval = F}
energy_monotonics <- filter(mod_summary, currency == "energy", monotonic, !lm_change, nbp > 0)
for(i in 1:nrow(energy_monotonics)) {
  thisdat <- filter(all_mods, site_curr == energy_monotonics$site_curr[i])

  thiscolor <- ifelse(energy_monotonics$lm_change[i], "red", "blue")


  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}

cvs <- energy_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)

```


#### "Static"

```{r plot energy monot flat no steps, fig.dim = c(2,2), eval = F}
energy_monotonics <- filter(mod_summary, currency == "energy", monotonic, !lm_change, nbp == 0)
for(i in 1:nrow(energy_monotonics)) {
  thisdat <- filter(all_mods, site_curr == energy_monotonics$site_curr[i])

  thiscolor <- ifelse(energy_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(energy_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}


cvs <- energy_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)

```


### Inscreasing

```{r plot energy monot inc, fig.dim = c(2,2), eval = F}
energy_monotonics <- filter(mod_summary, currency == "energy", monotonic, lm_change, lm_increase)
for(i in 1:nrow(energy_monotonics)) {
  thisdat <- filter(all_mods, site_curr == energy_monotonics$site_curr[i])

  thiscolor <- ifelse(energy_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(energy_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}


cvs <- energy_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)
```

### Decreasing

```{r plot energy monot dec, fig.dim = c(2,2), eval = F}
energy_monotonics <- filter(mod_summary, currency == "energy", monotonic, lm_change, lm_decrease)
for(i in 1:nrow(energy_monotonics)) {
  thisdat <- filter(all_mods, site_curr == energy_monotonics$site_curr[i])

  thiscolor <- ifelse(energy_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(energy_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
     geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}


cvs <- energy_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)
```

## Turns

### No significant trend

#### Steps

```{r plot energy turns no trend, fig.dim = c(2,2), eval = F}
energy_monotonics <- filter(mod_summary, currency == "energy", !monotonic, !lm_change, nbp > 0)
for(i in 1:nrow(energy_monotonics)) {
  thisdat <- filter(all_mods, site_curr == energy_monotonics$site_curr[i])

  thiscolor <- ifelse(energy_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(energy_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}



cvs <- energy_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)

```


### Increasing

```{r plot energy turns inc, fig.dim = c(2,2), eval = F}
energy_monotonics <- filter(mod_summary, currency == "energy", !monotonic, lm_change, lm_increase)
for(i in 1:nrow(energy_monotonics)) {
  thisdat <- filter(all_mods, site_curr == energy_monotonics$site_curr[i])

  thiscolor <- ifelse(energy_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(energy_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
     geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}


cvs <- energy_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)
```

### Decreasing

```{r plot energy turns dec, fig.dim = c(2,2), eval = F}
energy_monotonics <- filter(mod_summary, currency == "energy", !monotonic, lm_change, lm_decrease)
for(i in 1:nrow(energy_monotonics)) {
  thisdat <- filter(all_mods, site_curr == energy_monotonics$site_curr[i])

  thiscolor <- ifelse(energy_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(energy_monotonics$cap_change[i], 1, 5)


  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor, size = 3, alpha = .3) +
    geom_line(aes(time, fitted), color = thiscolor, linetype = 4, size = 2) +
    theme_bw() +
      ggtitle(thisdat$site_name[1]))
}


cvs <- energy_monotonics %>%
  select(site_name, cv) %>%
  distinct()

ggplot(cvs, aes(x = 1, y=cv)) +
  geom_boxplot() +
  geom_point() +
  theme_bw() +
  ggtitle("Coeff of var") +
  ylim(0,1)
```

# E in comparison to N

```{r e v n}
a_summary <-all_mods %>%
  filter(currency == "abundance") %>%
  select(-time, -response, -fitted, -breakpoints) %>%
  distinct() %>%
  mutate(cap_lm_agree = cap_change == lm_change)

colnames(a_summary)

both_summary <- bind_rows(a_summary, mod_summary) %>%
  select(site_name, currency, lm_change_word, lm_change_description, cap_change_word, cap_change_description, monotonic_word) %>%
  tidyr::pivot_wider(id_cols = site_name, names_from = currency, values_from = c(lm_change_word, lm_change_description, cap_change_word, cap_change_description, monotonic_word))


ggplot(both_summary, aes(x = lm_change_description_energy, fill = lm_change_description_abundance)) +
  geom_bar() +
  theme_bw() +
  scale_fill_viridis_d()


ggplot(both_summary, aes(x = cap_change_description_energy, fill = cap_change_description_abundance)) +
  geom_bar() +
  theme_bw() +
  scale_fill_viridis_d()


```

```{r tables}

turns_match <- both_summary %>%
  group_by(monotonic_word_abundance,
           monotonic_word_energy) %>%
  summarize(n = dplyr::n())

turns_match

```

For 30 communities, both TS are monotonic.

For another 30, one is monotonic and one turns. Which is which is an even split.

For the remaining 48, both have turns. 

Of those where both are monotonic:

```{r both monotonic}

both_mono <- both_summary %>%
  filter(monotonic_word_abundance == "monotonic",
         monotonic_word_energy == "monotonic")

just_mono <- both_mono %>%
  group_by(lm_change_description_abundance,
           lm_change_description_energy) %>%
  summarize(n = dplyr::n())%>%
  ungroup() %>%
  mutate(percent = n / sum(n))

just_mono

```

The two TS match for 22 of the 30 TS. That is 6 decreases, 5 increases, and 11 no changes. 

3 times, abundance decreases and E does not change.

1 time, abundance does not change but E decreases.

4 times, abundance does not change but E increases. 

Abundance never increases without E increasing. 

```{r all not just mono}
turns_and_mono <- both_summary %>%
  group_by(lm_change_description_abundance,
           lm_change_description_energy) %>%
  summarize(n = dplyr::n()) %>%
  ungroup() %>%
  mutate(percent = n / sum(n))

turns_and_mono

```

Including turning ones:

71 times they match. That is 21 decreases, 13 increases, and 37 no trends.

2 times N decreases but E increases.
17 times N decreases and E does not change.

4 times N does not change but E decreases.
9 times N does not change but E increases. 

5 times N increases and E does not change.


```{r comparing turns v just mono}

everything <- left_join(turns_and_mono, rename(just_mono, n_mono=n, percent_mono=percent))

everything %>%
  arrange(percent)

```

The above is really hard to interpret. 

```{r long summary, fig.dim = c(5,5)}

long_summary <- bind_rows(a_summary, mod_summary) %>%
  select(site_name, currency, lm_change_word, lm_change_description, cap_change_word, cap_change_description, monotonic_word) %>%
  group_by(currency, monotonic_word) %>%
  mutate(n_monotonic = dplyr::n()) %>%
  ungroup() %>%
  group_by(currency, monotonic_word, lm_change_description) %>%
  summarize(n_this_outcome = dplyr::n(), 
    percent_this_outcome = dplyr::n() / n_monotonic) %>%
  ungroup() %>%
  distinct()

ggplot(filter(long_summary, monotonic_word == "monotonic"), aes(currency, percent_this_outcome, fill = lm_change_description)) +
  geom_col(position = "dodge") +
  facet_wrap(vars(monotonic_word)) +
  scale_fill_viridis_d(end = .8) +
  theme_bw() +
  theme(legend.position = "top")

long_summary %>%
  group_by(currency) %>%
  mutate(n_this_turn = sum(n_this_outcome)) %>%
  ungroup() %>%
  group_by(currency, monotonic_word) %>%
  summarize(prop_this_turn = sum(n_this_outcome)/ n_this_turn) %>%
  distinct()

```
