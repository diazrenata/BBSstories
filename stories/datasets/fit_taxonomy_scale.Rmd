---
title: "Interpreting breakpoint fits"
output: github_document
params:
 this_dataset: ["all"]
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)
library(dplyr)
library(ggplot2)
library(strucchange)
```

## An idea

Look specifically at the predictions from the best-fitting breakpoint model. (This model could be: no breakpoints + no slope, no breakpoints + slope, n breakpoints + no slope, n breakpoints + slopes).

There's some qualitative behaviors we can extract from the predictions (that come logically but less elegantly from the parameters, etc).

Two axes:

1. **Monotonic or squiggly:** Monotonic can encompass all linear (no-break) models, _and_ any models with breakpoints that do not result in changes in direction. 
2. **Net change or net 0:** The ratio of the end:beginning _prediction_.

The 2x2:

1. **Monotonic** and **net change**: This would be some kind of overall trend, either steady (probably would show as a 1-segment linear model), possibly accelerating or decelerating across the timeseries (would show as multiple segments with slopes), or even as a series of abrupt changes (would show as multiple segments with *no* slopes).
2. **Monotonic** and **no net change**: This can basically only be accomplished as a one-segment linear model with a slope very close to 0. (Theoretically you could have many verrrrry gently sloping segments, but I doubt we have the statistical power such that something like that would emerge as the best fit). I think this is either very stable or *so* variable that not even many breakpoints can adequately capture the variability. 
3. **Turnpoints** and **net change**: The TS changes direction at least once, and ends up somewhere other than where it started. This *must* involve breakpoints. At the moment I think I have less confidence in such an outcome as evidence of systematic directional change - it seems potentially sensitive to, if we stopped surveying 5 years earlier, would we have a totally different trend? 
4. **Turnpoints** and **no net change**: Qualitatively different from, monotonic and no net change....Again, I am not sure how confident I am in this as a signal of any kind of regulation/buffering. But maybe. 


### Illustration via a few real datasets

```{r loading some real datasets, fig.dim = c(6, 24)}

site_names <- list.files(path = "C:\\Users\\diaz.renata\\Documents\\GitHub\\BBSsize\\analysis\\isd_data", pattern = "ibd_isd_bbs_", full.names = F)
site_names <- substr(site_names, 18, nchar(site_names))
site_names <- substr(site_names, 1, nchar(site_names) - 4)

datasets <- data.frame(
  dataset_name = site_names,
  rtrg_code = paste0("rtrg_", site_names)
)


all_datasets <- list()


for(i in 1:nrow(datasets)) {

  if(datasets$dataset_name[i] != "portal_rats") {

    ibd <- readRDS(paste0("C:\\Users\\diaz.renata\\Documents\\GitHub\\BBSsize\\analysis\\isd_data\\ibd_isd_bbs_", datasets$rtrg_code[i], ".Rds"))

    sv <- ibd %>%
      group_by(year) %>%
      summarize(richness = length(unique(id)),
                abundance = dplyr::n(),
                biomass = sum(ind_size),
                energy = sum(ind_b)) %>%
      ungroup() %>%
      mutate(mean_energy = energy / abundance,
             mean_mass = biomass/abundance,
             site_name = datasets$dataset_name[i])

    if(datasets$dataset_name[i] == "gainesville_nooutlier") {
      sv <- filter(sv, abundance < 3000)
    }
  } else {

    individual_rats <- portalr::summarise_individual_rodents(clean = TRUE, type = "Granivores", time = "date", length = "Longterm")

    ibd <- individual_rats %>%
      filter(year %in% c(1978:2002), !is.na(wgt), treatment == "control") %>%
      mutate(six_mo = ifelse(month > 6, .5, 0)) %>%
      mutate(year_six_mo = (year + six_mo)) %>%
      mutate(bmr = 5.69 * (wgt ^ .75)) %>%
      select(year_six_mo, species, wgt, bmr) %>%
      rename(year= year_six_mo,
             id = species,
             ind_size = wgt,
             ind_b = bmr) %>%
      mutate(id = as.character(id))


    sv <- ibd %>%
      group_by(year) %>%
      summarize(richness = length(unique(id)),
                abundance = dplyr::n(),
                biomass = sum(ind_size),
                energy = sum(ind_b)) %>%
      ungroup() %>%
      mutate(mean_energy = energy / abundance,
             mean_mass = biomass/abundance,
             site_name = datasets$dataset_name[i]) %>%
      mutate(time = row_number())

  }

  all_datasets[[i]] <- sv


}

all_datasets <- bind_rows(all_datasets)


```

```{r breakpoints fxns}
source(here::here("stories", "datasets", "fxns.R"))

```

```{r multiple datasets}

abund_mods <- list()

for(i in 1:nrow(datasets)) {
  thisdat <- subset_all_datasets(site = datasets$dataset_name[i], curr = "abundance", all_datasets = all_datasets)

  abund_mods[[i]] <- summarize_breakpoints(thisdat, fit_breakpoints(thisdat))
}

abund_mods <- dplyr::bind_rows(abund_mods)
# 
# ggplot(abund_mods, aes(time, response, color = monotonic)) +
#   geom_line() +
#   geom_point(aes(time, fitted)) +
#   facet_wrap(vars(site_name), scales = "free")



energy_mods <- list()

for(i in 1:nrow(datasets)) {
  thisdat <- subset_all_datasets(site = datasets$dataset_name[i], curr = "energy", all_datasets = all_datasets)

  energy_mods[[i]] <- summarize_breakpoints(thisdat, fit_breakpoints(thisdat))
}

energy_mods <- dplyr::bind_rows(energy_mods)
# 
# ggplot(energy_mods, aes(time, response, color = monotonic)) +
#   geom_line() +
#   geom_point(aes(time, fitted)) +
#   facet_wrap(vars(site_name), scales = "free")

all_mods <- bind_rows(energy_mods, abund_mods) %>%
  mutate(site_curr = paste0(as.character(site_name), currency)) %>%
  mutate(cap_change = cap_p_wilcox <= 0.05,
         lm_change = lm_p_ratio != 1)
```

<!-- ### Monotonic and net change -->

<!-- ```{r monotonic net} -->

<!-- m_nc <- filter(all_mods, monotonic, net_change != 1) -->

<!-- ggplot(m_nc, aes(time, response)) + -->
<!--   geom_line() + -->
<!--   geom_point(aes(time, fitted)) + -->
<!--   theme_bw() + -->
<!--   facet_wrap(vars(site_curr), scales = "free") -->


<!-- ``` -->

<!-- ### Monotonic and no net change -->

<!-- ```{r monotonic no net} -->

<!-- m_nzero <- filter(all_mods, monotonic, net_change == 1) %>% -->
<!--   group_by(site_curr) %>% -->
<!--   mutate(cv = sd(response) / mean(response)) %>% -->
<!--   ungroup() -->

<!-- ggplot(m_nzero, aes(time, response)) + -->
<!--   geom_line() + -->
<!--   geom_point(aes(time, fitted)) + -->
<!--   theme_bw() + -->
<!--   facet_wrap(vars(site_curr), scales = "free") -->


<!-- ``` -->

<!-- ### Turnpoints and net change -->


<!-- ```{r turns net} -->

<!-- t_nc <- filter(all_mods, !monotonic, net_change != 1) -->

<!-- ggplot(t_nc, aes(time, response)) + -->
<!--   geom_line() + -->
<!--   geom_point(aes(time, fitted)) + -->
<!--   theme_bw() + -->
<!--   facet_wrap(vars(site_curr), scales = "free") -->


<!-- ggplot(t_nc, aes(time, response, color = cap_p_wilcox <= .05)) + -->
<!--   geom_line() + -->
<!--   geom_point(aes(time, fitted)) + -->
<!--   theme_bw() + -->
<!--   facet_wrap(vars(site_curr), scales = "free") -->



<!-- ggplot(t_nc, aes(time, response, color = lm_p_ratio != 1)) + -->
<!--   geom_line() + -->
<!--   geom_point(aes(time, fitted)) + -->
<!--   theme_bw() + -->
<!--   facet_wrap(vars(site_curr), scales = "free") -->

<!-- ``` -->


### Histograms


```{r hists}

mod_summary <- all_mods %>%
  select(-time, -response, -fitted, -breakpoints) %>%
  distinct()

ggplot(mod_summary, aes(x = cap_ratio)) +
  geom_histogram() +
  theme_bw() +
  facet_wrap(vars(currency, monotonic), scales = "free")

ggplot(mod_summary, aes(x = lm_ratio)) + 
 geom_histogram() +
  theme_bw() +
  facet_wrap(vars(currency, monotonic), scales = "free")
```

```{r summary}

mod_summary_summary <- mod_summary %>%
  group_by(currency) %>%
  mutate(total_n_sites = dplyr::n(),
         currency_n_monotonic = sum(monotonic)) %>%
  ungroup() %>%
  group_by(currency, monotonic) %>%
  mutate(n_cap_change = sum(cap_change),
         n_lm_change = sum(lm_change),
         n_sites = n()) %>%
  ungroup() %>%
  select(currency, currency_n_monotonic, total_n_sites, monotonic, n_cap_change, n_lm_change, n_sites) %>%
  distinct() %>%
  mutate(prop_cap_change = n_cap_change/n_sites,
         prop_lm_change = n_lm_change / n_sites,
         prop_monotonic = currency_n_monotonic / total_n_sites)
mod_summary_summary

```

# Abundance

## Monotonics

```{r plot abundance, fig.dim = c(2,2)}
abund_monotonics <- filter(mod_summary, currency == "abundance", monotonic)
for(i in 1:nrow(abund_monotonics)) {
  thisdat <- filter(all_mods, site_curr == abund_monotonics$site_curr[i])
  
  thiscolor <- ifelse(abund_monotonics$lm_change[i], "red", "blue")
  thisshape <- ifelse(abund_monotonics$cap_change[i], 1, 5)
  
  
  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor) +
    geom_point(aes(time, fitted), color = thiscolor, shape = thisshape) +
    theme_bw())
}

```


## Turns

```{r plot abundance turns, fig.dim = c(2,2)}
abund_turns <- filter(mod_summary, currency == "abundance", !monotonic)
for(i in 1:nrow(abund_turns)) {
  thisdat <- filter(all_mods, site_curr == abund_turns$site_curr[i])
  
  thiscolor <- ifelse(abund_turns$lm_change[i], "red", "blue")
    thisshape <- ifelse(abund_monotonics$cap_change[i], 1, 5)

  print(ggplot(thisdat, aes(x = time, y = response)) +
    geom_line(color = thiscolor) +
    geom_point(aes(time, fitted), color = thiscolor, shape = thisshape) +
    theme_bw())
}

```
