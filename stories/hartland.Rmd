---
title: "BBS route that goes by Hartland"
output: 
    github_document:
       df_print: kable
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(bbstrends)
library(dplyr)
library(ggplot2)
```


### Load specific route

The New Hartford route goes up and down Riverton Road and was started in 1994. It feels pretty auspicious. It is route 102, region 18.

```{r load route}

ibd <- readRDS("C:\\Users\\diaz.renata\\Documents\\GitHub\\BBSsize\\analysis\\isd_data\\ibd_isd_bbs_rtrg_102_18.Rds")
```

Here are the species present in this route over the past 25 years:

```{r species list for fun}

ibd_species <- ibd %>%
  select(id) %>%
  distinct()

species_list <- read.csv("C:\\Users\\diaz.renata\\Documents\\GitHub\\BBSsize\\analysis\\species_data\\species_list_working.csv", stringsAsFactors = F)

species_list <- species_list %>%
  select(id, english_common_name)

ibd_species <- left_join(ibd_species, species_list) %>%
  distinct()

ibd_species

```

Here is how species richness, abundance, biomass, and energy have changed over those years:

```{r state variables}

sv <- ibd %>%
  group_by(year) %>%
  summarize(richness = length(unique(id)),
            abundance = dplyr::n(),
            biomass = sum(ind_size),
            energy = sum(ind_b)) %>%
  ungroup() %>%
  mutate(mean_energy = energy / abundance,
         mean_mass = biomass/abundance)


sv_long <- sv %>%
  tidyr::pivot_longer(-year, names_to = "currency", values_to = "value")

ggplot(filter(sv_long, !grepl("mean", currency)), aes(x = year, y = value, color = currency)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  scale_color_viridis_d(end = .8) +
  theme(legend.position = "none") +
  facet_wrap(vars(currency), scales = "free_y")

```

Here is population abundances:

```{r pops, fig.dim = c(10, 6)}

pops <- ibd %>%
  select(year, id) %>%
  group_by(year, id) %>%
  summarize(abund = dplyr::n()) %>%
  ungroup() %>%
  group_by(year) %>%
  mutate(annual_abund = sum(abund)) %>%
  ungroup() %>%
  group_by_all() %>%
  mutate(prop_abund = abund / annual_abund) %>%
  ungroup()

ggplot(pops, aes(year, (prop_abund), color = id)) +
  geom_line() +
  theme_bw() +
  scale_color_viridis_d() +
  theme(legend.position = "none")

```

We can do some (crude) linear model fitting. I've generally been finding that lms are OK, with caveats:

- you do want to check for autocorrelation
- the normal q-q plots are often kind of wonky


```{r lms}

sv_long <- sv_long %>%
  group_by(currency) %>%
  mutate(scaled_value = scale(value)) %>%
  ungroup()

abund_lm <- lm(scaled_value ~ year, data = filter(sv_long, currency == "abundance"))

summary(abund_lm)

confint(abund_lm)


energy_lm <- lm(scaled_value ~ year, data = filter(sv_long, currency == "energy"))

summary(energy_lm)

confint(energy_lm)

```

So here the lms are generally aligning with what looks intuitive from the plots: a gentle decline in individual abundance, but no signal in energy. 


One thing that interests me is, energy looks more *variable* than abundance. 

```{r variability}

sd(sv$energy) / mean(sv$energy)

sd(sv$abundance) / mean(sv$abundance)

```

I'm kind of curious about, comparing individual year ISDs to some kind of overall mean ISD. 

```{r isd playing}


overall_isd <- data.frame(
  x =  density(log(ibd$ind_size), from = 0, to = 1.2 * max(log(ibd$ind_size)), n = 8192)$x,
  y = density(log(ibd$ind_size), from = 0, to = 1.2 * max(log(ibd$ind_size)), n = 8192)$y)

overall_isd <- overall_isd %>%
  mutate(y = y / sum(y))

make_year_isd <- function(thisyear, ibd) {
  this_ibd <- filter(ibd, year == thisyear)
  this_isd <- density(log(this_ibd$ind_size), from = 0, to = 1.2 * max(log(ibd$ind_size)), n = 8192)
  
  return(data.frame(x =this_isd$x,
                    y = this_isd$y / sum(this_isd$y),
                    year = thisyear))
}


year_isds <- lapply(unique(ibd$year), FUN = make_year_isd, ibd = ibd)


year_isds <- bind_rows(year_isds)

ggplot(overall_isd, aes(x, y)) +
  geom_point() +
  theme_bw() +
  geom_line(data = year_isds, aes(x = x, y = y, group = year), alpha = .1)


ggplot(filter(year_isds, year == 2010), aes(x =x, y=y)) +
  geom_line()

overall_isd <- overall_isd %>%
  rename(overall_y = y)

year_isds <- year_isds %>%
  left_join(overall_isd)

year_isds <- year_isds %>%
  mutate(ydiff = y - overall_y)

ggplot(filter(year_isds), aes(x, ydiff, group = year, color = year)) +
  geom_line(alpha = .2) +
  theme_bw() +
  scale_color_viridis_c(end = .9) +
  facet_wrap(vars(year))


```

The intuitive description, to me, of these dynamics is a fairly believable trend in abundance, but *highly variable* energy that does not map clearly onto time. I would *not* call this compensation, because of the poor correspondence between abundance and mean energy use:

```{r abund v compensation}

hypothetical_e <- mean(sv$energy)

sv$hypothetical_mean_e = hypothetical_e / sv$abundance

ggplot(sv, aes(x = abundance, y = mean_energy, color = energy)) +
  geom_point()

ggplot(sv, aes(abundance, energy, color = year)) +
  geom_point()
```

I think what I mean is, if energy had a slope of 0 over time in a *fixed* way, then when abundance is high mean energy should be low. But I don't really see support for that. It looks to me a lot more like energy varies a lot but not systematically with time; it's not fixed but free. 

```{r energy v abund}

summary(lm(scale(energy) ~ scale(abundance), sv))
summary(lm(scale(mean_energy) ~ scale(abundance), sv))

```

### Randomizing the ISD

```{r randomize isd}

randomized_isd_e <- function(thisyear, ibd) {
  
  this_abund <- nrow(ibd [ which(ibd$year == thisyear), ])
  
  sampled_ind_b <- ibd$ind_b[ sample.int(nrow(ibd), size = this_abund, replace = F)]
  
  return(data.frame(
    year = thisyear,
    energy = sum(sampled_ind_b)))

}



randomized_es <- lapply(unique(sv$year), FUN = function(thisyear, ibd, times) return(bind_rows(replicate(n = times, expr = randomized_isd_e(thisyear = thisyear, ibd = ibd), simplify = F), .id = "rep")), ibd = ibd, times = 1000)


randomized_es <- bind_rows(randomized_es)

ggplot(randomized_es, aes(year, energy, group = year)) +
  geom_violin() +
  geom_point(data = sv, color = "red") +
  theme_bw()

```


Here is something I've done mostly following intuition. I think it shows how each year's observed total energy use scores relative to if it had tracked an overall single ISD. This is a bootstrapping/simulating approach intended to get a sense of some of the variation from lowish N, and start to partition abundance from ISD.

The violins represent the distribution of *total energy values* for 1000 bootstrap sampled ISDs. Each simulated ISD is a draw of the *observed number of individuals* from the pool of *all individuals observed across all years*. The pool includes the individuals actually observed that year. I've done it with or without replacement and I don't see a big obvious difference, but there are numerous questions in a similar vein that one could chase down. You could do an ISD as equal weight to each timestep (regardless of abundance) and then the mean density at each body size; that would remove some weight from time steps with high abundances. It also might be preferable to remove the observed year from the pool. 

So one thing I find interesting about this exercise is to ask whether the position of the observed E shifts systematically over time. 

I think, for observations to be consistent with a *single unchanging ISD* from which we draw N individuals at random every year, you'd expect the total E to track the violins. 

It might be interesting to look at comparisons to the overall ISD, vs a pool from a local short time period, vs a pool from the same number of time steps randomly distributed. So, how does E in 1990 compare to a random draw from a pool of `r c(1988, 1989, 1991, 1992)`, vs a random draw from a pool of  `r sample(c(1994:1989, 1991:2019), size = 4, replace = F)`? If observations are closer to a local moving average ISD, than to one randomly dispersed in time, you have some kind of temporal structure in the variability. But if not, there's variability but it's not structured temporally. 

